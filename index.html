<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Court</title>
  <!-- Load Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Basic Reset & Global Styles */
    * {
      margin: 0; padding: 0; box-sizing: border-box;
    }
    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #fff;
      color: #000;
      line-height: 1.6;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 80px; /* Space for fixed header */
      min-height: 100vh;
      /* Subtle background pattern - SVG Court Lines */
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' stroke='%23E0E0E0' stroke-width='0.5'%3E%3Ccircle cx='50' cy='50' r='40'/%3E%3Cpath d='M50 0 V100 M0 50 H100 M30 10 H70 M30 90 H70 M10 30 V70 M90 30 V70'/%3E%3C/g%3E%3C/svg%3E");
      background-size: 200px 200px;
      background-repeat: repeat;
    }
    #app {
      width: 100%;
      max-width: 500px;
      padding: 20px;
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }
    /* Header */
    header {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      background-color: #fff;
      padding: 10px 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }
    .app-title {
      font-size: 1.5em;
      font-weight: bold;
    }
    .auth-buttons button,
    .auth-buttons span {
      margin-left: 10px;
      padding: 8px 15px;
      font-size: 0.9em;
    }

    /* Page Sections */
    .page {
      display: none;
      width: 100%;
      flex-grow: 1;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      animation: fadeIn 0.5s ease-in-out;
    }
    .page.active { display: flex; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Common Elements */
    h2 {
      margin-bottom: 25px; font-weight: 600; text-align: center;
    }
    label {
      display: block; margin-bottom: 5px; font-weight: 500;
    }
    input[type="text"],
    input[type="password"],
    input[type="email"],
    select {
      width: 100%; padding: 12px; margin-bottom: 15px;
      border: 1px solid #ccc; border-radius: 20px; font-size: 1em;
    }
    button {
      padding: 12px 25px;
      background-color: #000;
      color: #fff;
      border: none; border-radius: 25px;
      cursor: pointer; font-size: 1em; font-weight: 500;
      transition: background-color 0.3s ease, transform 0.1s ease;
      display: inline-block;
    }
    button:disabled {
      background-color: #ccc; cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #333;
    }
    button:active:not(:disabled) {
      transform: scale(0.98);
    }
    .form-group {
      margin-bottom: 15px; width: 100%;
    }
    .button-group {
      display: flex; flex-direction: column; align-items: center;
      gap: 15px; margin-top: 20px; width: 100%;
    }
    .button-group button {
      width: 80%; max-width: 300px;
    }
    .link-button {
      background: none; border: none; color: #007bff; text-decoration: underline;
      cursor: pointer; padding: 5px; font-size: 0.9em;
    }
    .link-button:hover { color: #0056b3; }
    .back-button {
      margin-top: 30px; background-color: #6c757d; font-size: 0.9em;
    }
    .back-button:hover { background-color: #5a6268; }

    /* Home Page */
    #home-page .basketball-icon {
      font-size: 4em; margin-bottom: 20px; text-align: center;
    }
    #home-page .basketball-icon svg {
      width: 60px; height: 60px; fill: #000;
    }

    /* Create Game Page */
    #create-game-page .game-type-select label {
      margin-right: 15px; display: inline-block;
    }
    #create-game-page .game-type-select input[type="radio"] {
      margin-right: 5px; width: auto; vertical-align: middle;
    }
    #game-code-display {
      margin-top: 20px; font-size: 1.2em; font-weight: bold;
      background-color: #f0f0f0; padding: 10px 15px; border-radius: 5px;
      text-align: center; word-break: break-all;
    }
    #game-code-display:empty {
      display: none;
    }

    /* Check Rank Page */
    #check-rank-page #rank-display,
    #leaderboard-page .leaderboard-list {
      margin-top: 20px; padding: 15px; background-color: #f8f9fa;
      border-radius: 5px; text-align: center; width: 100%;
    }

    /* Leaderboard Page */
    #leaderboard-page .leaderboard-list ul {
      list-style: none; padding: 0;
    }
    #leaderboard-page .leaderboard-list li {
      padding: 8px 0; border-bottom: 1px solid #eee;
      display: flex; justify-content: space-between; flex-wrap: wrap; gap: 5px;
    }
    #leaderboard-page .leaderboard-list li:last-child {
      border-bottom: none;
    }
    #leaderboard-page .leaderboard-list .rank { font-weight: bold; margin-right: 10px; }
    #leaderboard-page .leaderboard-list .name { flex-grow: 1; text-align: left; }
    #leaderboard-page .leaderboard-list .location { font-size: 0.9em; color: #555; }
    #leaderboard-page .leaderboard-list .score { font-style: italic; color: #555; margin-left: 10px; }
    #leaderboard-page .leaderboard-controls {
      margin-bottom: 15px; text-align: center;
    }
    #leaderboard-page .leaderboard-controls button {
      margin: 0 5px; padding: 5px 10px; font-size: 0.9em;
      background-color: #e9ecef; color: #000;
    }
    #leaderboard-page .leaderboard-controls button.active {
      background-color: #000; color: #fff;
    }
    #leaderboard-page .leaderboard-controls button:disabled {
      background-color: #f8f9fa; color: #aaa; cursor: not-allowed;
    }

    /* Form feedback/error messages */
    .error-message {
      color: #dc3545; font-size: 0.9em;
      margin-top: -10px; margin-bottom: 10px;
      text-align: center; display: none;
    }
    .success-message {
      color: #28a745; font-size: 0.9em;
      margin-top: 10px; margin-bottom: 10px;
      text-align: center; display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="app-title">Court</div>
    <div class="auth-buttons">
      <span id="user-display" style="display: none; margin-right: 15px;"></span>
      <button id="login-nav-btn">Login</button>
      <button id="signup-nav-btn">Sign Up</button>
      <button id="logout-btn" style="display: none;">Logout</button>
    </div>
  </header>

  <div id="app">
    <!-- Home Page -->
    <section id="home-page" class="page active">
      <div class="basketball-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM133.3 89.9C161.4 60.8 216 32 256 32s94.6 28.8 122.7 57.9c1.7 1.7 3.1 3.7 3.8 5.9l-16.1 2.1C360.7 90.1 313.8 72 256 72s-104.7 18.1-110.4 25.9l-16.1-2.1c.7-2.1 2.1-4.1 3.8-5.9zM392.9 112.3c-1.7-1.7-3.1-3.7-3.8-5.9L373 108.5c5.7 7.8 10.4 16.2 13.9 24.9L410.7 131c-6.4-10.4-14.7-19.6-24.7-26.5l-10.9-7.2c-6-3.9-12.3-6.9-18.8-8.8l-1.8-15.7c11.2 3.3 21.7 8.4 31.1 15.2zM99.1 112.3C109 105.3 120.1 100 132.3 97.2L130.5 113c-6.5 1.9-12.8 4.9-18.8 8.8l-10.9 7.2C90.8 135.4 82.5 144.6 76.1 155l23.8-2.3c3.5-8.7 8.2-17.1 13.9-24.9L99.1 112.3zm74.7 281.7C146.6 373.2 92 344 52 344s-94.6-29.2-122.7-58.3c-1.7-1.7-3.1-3.7-3.8-5.9l16.1-2.1c5.7 7.8 52.6 25.9 110.4 25.9s104.7-18.1 110.4-25.9l16.1 2.1c-.7 2.1-2.1 4.1-3.8 5.9zM101.3 380.7l-23.8 2.3c6.4 10.4 14.7 19.6 24.7 26.5l10.9 7.2c6 3.9 12.3 6.9 18.8 8.8l1.8 15.7C120.1 438.1 109 433 99.1 426.2l-11.7-7.6c-9.5-6.2-17.9-13.7-24.9-22.4zm287.8-22.4c-7 8.7-15.5 16.2-24.9 22.4l-11.7 7.6c-9.9 6.8-20.9 11.9-32.7 15.2l1.8-15.7c6.5-1.9 12.8-4.9 18.8-8.8l10.9-7.2c10-6.9 18.3-16.1 24.7-26.5l23.8 2.3zm-13.9-24.9L373 331.5c-5.7-7.8-10.4-16.2-13.9-24.9l-23.8 2.3c6.4-10.4 14.7-19.6 24.7-26.5l10.9-7.2c6-3.9 12.3-6.9 18.8-8.8l1.8-15.7c11.2 3.3 21.7 8.4 31.1 15.2l11.7 7.6c9.5 6.2 17.9 13.7 24.9 22.4l-16.1-2.1c-5.7-7.8-52.6-25.9-110.4-25.9s-104.7 18.1-110.4 25.9l-16.1 2.1zm-18.8 8.8l-10.9 7.2c-10 6.9-18.3 16.1-24.7 26.5L101.3 380.7l16.1 2.1c.7-2.1 2.1-4.1 3.8-5.9c28.1-29.2 82.7-58.3 122.7-58.3s94.6 29.2 122.7 58.3c1.7 1.7 3.1 3.7 3.8 5.9l16.1-2.1c-.7-2.1-2.1-4.1-3.8-5.9c-28.1-29.2-82.7-58.3-122.7-58.3s-94.6 29.2-122.7 58.3z"/>
        </svg>
      </div>
      <h2>Welcome to Court</h2>
      <p style="text-align: center; margin-bottom: 30px;">Organize your next pickup game.</p>
      <div class="button-group">
        <button id="nav-create-game" disabled>Create Game</button>
        <button id="nav-enter-game" disabled>Enter Game Code</button>
        <button id="nav-check-rank">Check Rank</button>
        <button id="nav-leaderboard">Leaderboard</button>
      </div>
    </section>

    <!-- Login Page -->
    <section id="login-page" class="page">
      <h2>Login</h2>
      <div id="login-error" class="error-message"></div>
      <form id="login-form" style="width: 100%;">
        <div class="form-group">
          <label for="login-username">Email</label>
          <input type="email" id="login-username" name="username" required autocomplete="username" />
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" name="password" required autocomplete="current-password" />
        </div>
        <div class="button-group">
          <button type="submit">Login</button>
          <button type="button" class="link-button" id="goto-signup">Don't have an account? Sign Up</button>
          <button type="button" class="back-button" data-target="home-page">Back to Home</button>
        </div>
      </form>
    </section>

    <!-- Sign Up Page -->
    <section id="signup-page" class="page">
      <h2>Sign Up</h2>
      <div id="signup-error" class="error-message"></div>
      <div id="signup-success" class="success-message"></div>
      <form id="signup-form" style="width: 100%;">
        <div class="form-group">
          <label for="signup-username">Username</label>
          <input type="text" id="signup-username" name="username" required minlength="3" maxlength="50" />
        </div>
        <div class="form-group">
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" name="email" required autocomplete="email" />
        </div>
        <div class="form-group">
          <label for="signup-password">Password</label>
          <input type="password" id="signup-password" name="password" required minlength="6" autocomplete="new-password" />
        </div>
        <div class="form-group">
          <label for="signup-confirm-password">Confirm Password</label>
          <input type="password" id="signup-confirm-password" name="confirm_password" required minlength="6" autocomplete="new-password" />
        </div>
        <div class="form-group">
          <label for="signup-city">City</label>
          <input type="text" id="signup-city" name="city" required />
        </div>
        <div class="form-group">
          <label for="signup-state">State (USA Only)</label>
          <select id="signup-state" name="state" required>
            <option value="" disabled selected>Select State</option>
            <option value="AL">Alabama</option> <option value="AK">Alaska</option>
            <option value="AZ">Arizona</option> <option value="AR">Arkansas</option>
            <option value="CA">California</option> <option value="CO">Colorado</option>
            <option value="CT">Connecticut</option> <option value="DE">Delaware</option>
            <option value="FL">Florida</option> <option value="GA">Georgia</option>
            <option value="HI">Hawaii</option> <option value="ID">Idaho</option>
            <option value="IL">Illinois</option> <option value="IN">Indiana</option>
            <option value="IA">Iowa</option> <option value="KS">Kansas</option>
            <option value="KY">Kentucky</option> <option value="LA">Louisiana</option>
            <option value="ME">Maine</option> <option value="MD">Maryland</option>
            <option value="MA">Massachusetts</option> <option value="MI">Michigan</option>
            <option value="MN">Minnesota</option> <option value="MS">Mississippi</option>
            <option value="MO">Missouri</option> <option value="MT">Montana</option>
            <option value="NE">Nebraska</option> <option value="NV">Nevada</option>
            <option value="NH">New Hampshire</option> <option value="NJ">New Jersey</option>
            <option value="NM">New Mexico</option> <option value="NY">New York</option>
            <option value="NC">North Carolina</option> <option value="ND">North Dakota</option>
            <option value="OH">Ohio</option> <option value="OK">Oklahoma</option>
            <option value="OR">Oregon</option> <option value="PA">Pennsylvania</option>
            <option value="RI">Rhode Island</option> <option value="SC">South Carolina</option>
            <option value="SD">South Dakota</option> <option value="TN">Tennessee</option>
            <option value="TX">Texas</option> <option value="UT">Utah</option>
            <option value="VT">Vermont</option> <option value="VA">Virginia</option>
            <option value="WA">Washington</option> <option value="WV">West Virginia</option>
            <option value="WI">Wisconsin</option> <option value="WY">Wyoming</option>
            <option value="DC">District of Columbia</option>
          </select>
        </div>
        <div class="button-group">
          <button type="submit">Sign Up</button>
          <button type="button" class="link-button" id="goto-login">Already have an account? Login</button>
          <button type="button" class="back-button" data-target="home-page">Back to Home</button>
        </div>
      </form>
    </section>

    <!-- Check Rank Page -->
    <section id="check-rank-page" class="page">
      <h2>Check Rank</h2>
      <div id="rank-error" class="error-message"></div>
      <form id="check-rank-form" style="width: 100%;">
        <div class="form-group">
          <label for="rank-username">Enter Username to Check</label>
          <input type="text" id="rank-username" name="rank_username" required />
        </div>
        <div class="button-group">
          <button type="submit">Check Rank</button>
        </div>
      </form>
      <div id="rank-display"></div>
      <div class="button-group">
        <button type="button" class="back-button" data-target="home-page">Back to Home</button>
      </div>
    </section>

    <!-- Enter Game Page -->
    <section id="enter-game-page" class="page">
      <h2>Enter Game</h2>
      <div id="enter-game-error" class="error-message"></div>
      <div id="enter-game-success" class="success-message"></div>
      <form id="enter-game-form" style="width: 100%;">
        <div class="form-group">
          <label for="game-code">Enter Game Code</label>
          <input type="text" id="game-code" name="game_code" required />
        </div>
        <div class="button-group">
          <button type="submit">Enter Game</button>
        </div>
      </form>
      <div class="button-group">
        <button type="button" class="back-button" data-target="home-page">Back to Home</button>
      </div>
    </section>

    <!-- Create Game Page -->
    <section id="create-game-page" class="page">
      <h2>Create Game</h2>
      <div id="create-game-error" class="error-message"></div>
      <div id="create-game-success" class="success-message"></div>
      <form id="create-game-form" style="width: 100%;">
        <div class="form-group game-type-select">
          <label>Select Game Type:</label><br />
          <input type="radio" id="type-1v1" name="game_type" value="1v1" required />
          <label for="type-1v1">1v1</label>
          <input type="radio" id="type-2v2" name="game_type" value="2v2" />
          <label for="type-2v2">2v2</label>
          <input type="radio" id="type-3v3" name="game_type" value="3v3" />
          <label for="type-3v3">3v3</label>
          <input type="radio" id="type-4v4" name="game_type" value="4v4" />
          <label for="type-4v4">4v4</label>
          <input type="radio" id="type-5v5" name="game_type" value="5v5" />
          <label for="type-5v5">5v5</label>
        </div>
        <div class="button-group">
          <button type="submit">Generate Game Code</button>
        </div>
      </form>
      <div id="game-code-display"></div>
      <div class="button-group">
        <button type="button" class="back-button" data-target="home-page">Back to Home</button>
      </div>
    </section>

    <!-- Leaderboard Page -->
    <section id="leaderboard-page" class="page">
      <h2>Leaderboard</h2>
      <div class="leaderboard-controls">
        <button id="leaderboard-city-btn" disabled>My City</button>
        <button id="leaderboard-state-btn" disabled>My State</button>
        <button id="leaderboard-country-btn" class="active">Country</button>
      </div>
      <div id="leaderboard-loading" style="text-align: center; margin: 20px;">Loading...</div>
      <div id="leaderboard-error" class="error-message"></div>
      <div id="leaderboard-display" class="leaderboard-list" style="display: none;">
        <h3 id="leaderboard-title">Country Leaderboard</h3>
        <ul id="leaderboard-ul"></ul>
      </div>
      <div class="button-group">
        <button type="button" class="back-button" data-target="home-page">Back to Home</button>
      </div>
    </section>
  </div> <!-- /#app -->

  <script>
    // --- Supabase Setup ---
    const SUPABASE_URL = 'https://noxophuyplfgcmjqinrb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5veG9waHV5cGxmZ2NtanFpbnJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM4ODMzMDIsImV4cCI6MjA1OTQ1OTMwMn0.UlX8E64FWEuJz1zJ1m9U9WDuyCRfHhV-AscEGzheTSU';

    let supabaseClient;
    try {
      if (!window.supabase || !supabase.createClient) {
        throw new Error("Supabase library not loaded correctly.");
      }
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase client initialized.');
    } catch (err) {
      console.error('Error initializing Supabase client:', err);
      supabaseClient = null;
      alert(`Failed to connect to backend: ${err.message}`);
    }

    // --- Global Vars ---
    let currentUser = null;
    let userProfile = null;

    // --- DOM Elements ---
    const pages = document.querySelectorAll('.page');
    const appDiv = document.getElementById('app');
    const loginNavBtn = document.getElementById('login-nav-btn');
    const signupNavBtn = document.getElementById('signup-nav-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userDisplay = document.getElementById('user-display');

    // Form & Display
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const checkRankForm = document.getElementById('check-rank-form');
    const enterGameForm = document.getElementById('enter-game-form');
    const createGameForm = document.getElementById('create-game-form');

    const loginErrorDiv = document.getElementById('login-error');
    const signupErrorDiv = document.getElementById('signup-error');
    const signupSuccessDiv = document.getElementById('signup-success');
    const rankErrorDiv = document.getElementById('rank-error');
    const rankDisplayDiv = document.getElementById('rank-display');
    const enterGameErrorDiv = document.getElementById('enter-game-error');
    const enterGameSuccessDiv = document.getElementById('enter-game-success');
    const createGameErrorDiv = document.getElementById('create-game-error');
    const createGameSuccessDiv = document.getElementById('create-game-success');
    const gameCodeDisplayDiv = document.getElementById('game-code-display');
    const leaderboardLoadingDiv = document.getElementById('leaderboard-loading');
    const leaderboardErrorDiv = document.getElementById('leaderboard-error');
    const leaderboardDisplayDiv = document.getElementById('leaderboard-display');
    const leaderboardUl = document.getElementById('leaderboard-ul');
    const leaderboardTitle = document.getElementById('leaderboard-title');
    const leaderboardCityBtn = document.getElementById('leaderboard-city-btn');
    const leaderboardStateBtn = document.getElementById('leaderboard-state-btn');
    const leaderboardCountryBtn = document.getElementById('leaderboard-country-btn');

    // --- Utility Functions ---
    function showPage(pageId) {
      pages.forEach(p => p.classList.remove('active'));
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.add('active');
        if (appDiv) appDiv.scrollTop = 0;

        // If going to leaderboard, fetch it
        if (pageId === 'leaderboard-page' && supabaseClient) {
          fetchLeaderboard('country');
          setActiveLeaderboardButton(leaderboardCountryBtn);
        }
      } else {
        console.error(`Page ${pageId} not found. Going home.`);
        document.getElementById('home-page').classList.add('active');
      }
    }
    function displayError(elem, msg) {
      if (elem) {
        elem.textContent = msg;
        elem.style.display = msg ? 'block' : 'none';
      }
    }
    function displaySuccess(elem, msg) {
      if (elem) {
        elem.textContent = msg;
        elem.style.display = msg ? 'block' : 'none';
      }
    }
    function clearMessages(...elems) {
      elems.forEach(el => {
        if (el) {
          el.textContent = '';
          el.style.display = 'none';
        }
      });
    }
    function generateGameCode(length = 5) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }
    function setActiveLeaderboardButton(activeBtn) {
      [leaderboardCityBtn, leaderboardStateBtn, leaderboardCountryBtn].forEach(btn => {
        btn?.classList.remove('active');
      });
      activeBtn?.classList.add('active');
    }

    // --- Auth/Session ---
    async function checkUserSession() {
      if (!supabaseClient) return;
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        if (error) throw error;

        if (session && session.user) {
          currentUser = session.user;
          await fetchUserProfile(currentUser.id);
          updateUIForLoggedInUser();
          console.log('Session found for:', currentUser.email);
        } else {
          currentUser = null; userProfile = null;
          updateUIForLoggedOutUser();
          console.log('No active user session.');
        }
      } catch (err) {
        console.error('Session check error:', err);
        updateUIForLoggedOutUser();
      }
    }

    async function fetchUserProfile(userId) {
      if (!supabaseClient || !userId) {
        console.log('No client or userId for profile fetch.');
        userProfile = null; return;
      }
      console.log('Fetching profile for:', userId);
      try {
        const { data, error, status } = await supabaseClient
          .from('profiles')
          .select('username, city, state, rank_score')
          .eq('id', userId)
          .single();

        if (error && status !== 406) {
          console.error('Profile fetch error:', error);
          throw error;
        }
        if (data) {
          userProfile = data;
          console.log('Profile:', userProfile);
        } else {
          userProfile = null;
          console.log('No profile row for:', userId);
        }
        updateUserDisplay();
      } catch (err) {
        console.error('fetchUserProfile error:', err);
        userProfile = null;
        updateUserDisplay();
      }
    }

    function updateUIForLoggedInUser() {
      if (loginNavBtn) loginNavBtn.style.display = 'none';
      if (signupNavBtn) signupNavBtn.style.display = 'none';
      if (logoutBtn) logoutBtn.style.display = 'inline-block';
      if (userDisplay) userDisplay.style.display = 'inline-block';
      updateUserDisplay();

      const createBtn = document.getElementById('nav-create-game');
      const enterBtn = document.getElementById('nav-enter-game');

      if (enterBtn) enterBtn.disabled = false;
      if (createBtn) {
        // Need a city & state to create a game
        createBtn.disabled = !(userProfile && userProfile.city && userProfile.state);
      }
      // Leaderboard city/state
      if (leaderboardCityBtn) leaderboardCityBtn.disabled = !(userProfile && userProfile.city);
      if (leaderboardStateBtn) leaderboardStateBtn.disabled = !(userProfile && userProfile.state);
    }

    function updateUserDisplay() {
      if (!userDisplay) return;
      // Always prefer the username over email
      if (currentUser && userProfile && userProfile.username) {
        userDisplay.textContent = `Hi, ${userProfile.username}`;
      } else {
        // If no username in profile, show nothing (or show email fallback).
        userDisplay.textContent = currentUser ? `Hi, ${currentUser.email}` : '';
      }
    }

    function updateUIForLoggedOutUser() {
      if (loginNavBtn) loginNavBtn.style.display = 'inline-block';
      if (signupNavBtn) signupNavBtn.style.display = 'inline-block';
      if (logoutBtn) logoutBtn.style.display = 'none';
      if (userDisplay) {
        userDisplay.style.display = 'none';
        userDisplay.textContent = '';
      }
      currentUser = null; userProfile = null;

      const createBtn = document.getElementById('nav-create-game');
      const enterBtn = document.getElementById('nav-enter-game');
      if (createBtn) createBtn.disabled = true;
      if (enterBtn) enterBtn.disabled = true;
      if (leaderboardCityBtn) leaderboardCityBtn.disabled = true;
      if (leaderboardStateBtn) leaderboardStateBtn.disabled = true;

      // If on protected page, return home
      const activePage = document.querySelector('.page.active');
      if (activePage && ['create-game-page','enter-game-page'].includes(activePage.id)) {
        showPage('home-page');
      }
    }

    async function handleLogout() {
      if (!supabaseClient) return;
      clearMessages(loginErrorDiv, signupErrorDiv, rankErrorDiv, enterGameErrorDiv, createGameErrorDiv, leaderboardErrorDiv);
      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        updateUIForLoggedOutUser();
        showPage('home-page');
        console.log('User logged out.');
      } catch (err) {
        console.error('Logout error:', err);
        displayError(loginErrorDiv, 'Logout failed.');
      }
    }

    // --- Leaderboard ---
    async function fetchLeaderboard(scope = 'country', city = null, state = null) {
      if (!supabaseClient) return displayError(leaderboardErrorDiv, 'Backend not initialized');
      clearMessages(leaderboardErrorDiv);
      if (leaderboardLoadingDiv) leaderboardLoadingDiv.style.display = 'block';
      if (leaderboardUl) leaderboardUl.innerHTML = '';
      if (leaderboardDisplayDiv) leaderboardDisplayDiv.style.display = 'none';

      try {
        let query = supabaseClient
          .from('profiles')
          .select('username, city, state, rank_score')
          .not('username','is',null)
          .order('rank_score',{ ascending: false })
          .limit(50);

        let title = 'Leaderboard';
        if (scope === 'city' && city && state) {
          query = query.eq('city', city).eq('state', state);
          title = `Leaderboard - ${city}, ${state}`;
        } else if (scope === 'state' && state) {
          query = query.eq('state', state);
          title = `Leaderboard - ${state}`;
        } else {
          title = 'Leaderboard - Country';
        }
        if (leaderboardTitle) leaderboardTitle.textContent = title;

        const { data, error } = await query;
        if (error) throw error;

        if (data && data.length > 0 && leaderboardUl) {
          leaderboardUl.innerHTML = data.map((p, i) => `
            <li>
              <span class="rank">${i+1}.</span>
              <span class="name">${p.username}</span>
              <span class="location">(${p.city}, ${p.state})</span>
              <span class="score">${p.rank_score} pts</span>
            </li>
          `).join('');
          if (leaderboardDisplayDiv) leaderboardDisplayDiv.style.display = 'block';
        } else if (leaderboardUl) {
          leaderboardUl.innerHTML = '<li>No players found.</li>';
          if (leaderboardDisplayDiv) leaderboardDisplayDiv.style.display = 'block';
        }
      } catch (err) {
        console.error('fetchLeaderboard error:', err);
        displayError(leaderboardErrorDiv, `Failed to load leaderboard: ${err.message}`);
      } finally {
        if (leaderboardLoadingDiv) leaderboardLoadingDiv.style.display = 'none';
      }
    }

    // --- Event Listeners ---
    document.getElementById('nav-create-game')?.addEventListener('click', () => showPage('create-game-page'));
    document.getElementById('nav-enter-game')?.addEventListener('click', () => showPage('enter-game-page'));
    document.getElementById('nav-check-rank')?.addEventListener('click', () => showPage('check-rank-page'));
    document.getElementById('nav-leaderboard')?.addEventListener('click', () => showPage('leaderboard-page'));
    loginNavBtn?.addEventListener('click', () => showPage('login-page'));
    signupNavBtn?.addEventListener('click', () => showPage('signup-page'));
    logoutBtn?.addEventListener('click', handleLogout);

    document.getElementById('goto-signup')?.addEventListener('click', () => showPage('signup-page'));
    document.getElementById('goto-login')?.addEventListener('click', () => showPage('login-page'));

    document.querySelectorAll('.back-button').forEach(btn => {
      btn.addEventListener('click', e => {
        const targetPageId = e.target.getAttribute('data-target');
        if (targetPageId) showPage(targetPageId);
        else showPage('home-page');
      });
    });

    leaderboardCityBtn?.addEventListener('click', () => {
      if (userProfile && userProfile.city && supabaseClient) {
        fetchLeaderboard('city', userProfile.city, userProfile.state);
        setActiveLeaderboardButton(leaderboardCityBtn);
      } else {
        displayError(leaderboardErrorDiv, 'Need city & state in profile to show city leaderboard');
      }
    });
    leaderboardStateBtn?.addEventListener('click', () => {
      if (userProfile && userProfile.state && supabaseClient) {
        fetchLeaderboard('state', null, userProfile.state);
        setActiveLeaderboardButton(leaderboardStateBtn);
      } else {
        displayError(leaderboardErrorDiv, 'Need state in profile to show state leaderboard');
      }
    });
    leaderboardCountryBtn?.addEventListener('click', () => {
      if (supabaseClient) {
        fetchLeaderboard('country');
        setActiveLeaderboardButton(leaderboardCountryBtn);
      }
    });

    // --- Login Form ---
    loginForm?.addEventListener('submit', async e => {
      e.preventDefault();
      if (!supabaseClient) return displayError(loginErrorDiv, 'Backend not initialized');
      clearMessages(loginErrorDiv, signupErrorDiv, signupSuccessDiv);

      const email = loginForm.username.value.trim();
      const password = loginForm.password.value;
      console.log('Attempting signInWithPassword for:', email);

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) {
          console.error('SignIn error:', error);
          throw error;
        }
        console.log('SignIn success:', data);
        loginForm.reset();
        showPage('home-page');
      } catch (err) {
        console.error('Login error:', err);
        displayError(loginErrorDiv, `Login failed: ${err.message}`);
      }
    });

    // --- Sign Up Form ---
    signupForm?.addEventListener('submit', async e => {
      e.preventDefault();
      if (!supabaseClient) return displayError(signupErrorDiv, 'Backend not initialized');
      clearMessages(signupErrorDiv, signupSuccessDiv, loginErrorDiv);

      const username = signupForm.username.value.trim();
      const email = signupForm.email.value.trim();
      const password = signupForm.password.value;
      const confirmPassword = signupForm.confirm_password.value;
      const city = signupForm.city.value.trim();
      const state = signupForm.state.value;

      if (password !== confirmPassword) {
        return displayError(signupErrorDiv, 'Passwords do not match.');
      }
      if (!username || !email || !password || !city || !state) {
        return displayError(signupErrorDiv, 'All fields are required.');
      }
      if (password.length < 6) {
        return displayError(signupErrorDiv, 'Password must be at least 6 characters.');
      }

      try {
        // 1. Create user (no email confirmations, per your settings)
        const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email, password });
        if (authError) throw new Error(`SignUp failed: ${authError.message}`);
        if (!authData.user) throw new Error('Signup succeeded, but no user returned.');

        console.log('Signup successful. User ID:', authData.user.id);

        // 2. Update profile with username, city, state, and start rank_score at 0
        const { data: updateData, error: profileError } = await supabaseClient
          .from('profiles')
          .update({
            username,
            city,
            state,
            rank_score: 0,    // Start them at 0 points
            updated_at: new Date()
          })
          .eq('id', authData.user.id)
          .select()
          .single();

        if (profileError) {
          console.error('Profile update error:', profileError);
          throw new Error(`Account created, but failed to save profile: ${profileError.message}`);
        }
        if (!updateData) {
          console.error('No profile row returned. Possibly RLS or missing row.');
          throw new Error('Profile row not updated. Check your RLS or triggers.');
        }
        console.log('Profile updated:', updateData);

        displaySuccess(signupSuccessDiv, 'Signup successful! You can now log in.');
        signupForm.reset();
        // Optionally go to login: showPage('login-page');
      } catch (err) {
        console.error('Signup error:', err);
        if (err.message.includes('duplicate key value') && err.message.includes('profiles_username_key')) {
          displayError(signupErrorDiv, 'This username is already taken.');
        } else {
          displayError(signupErrorDiv, `Signup failed: ${err.message}`);
        }
      }
    });

    // --- Check Rank ---
    checkRankForm?.addEventListener('submit', async e => {
      e.preventDefault();
      if (!supabaseClient) return displayError(rankErrorDiv, 'Backend not initialized');
      clearMessages(rankErrorDiv);
      rankDisplayDiv.innerHTML = '<p>Checking...</p>';

      const usernameToCheck = checkRankForm.rank_username.value.trim();
      if (!usernameToCheck) {
        return displayError(rankErrorDiv, 'Please enter a username.');
      }

      try {
        const { data, error } = await supabaseClient
          .from('profiles')
          .select('username, city, state, rank_score')
          .eq('username', usernameToCheck)
          .single();

        if (error) {
          console.error('Rank check error:', error);
          throw new Error(error.message.includes('PGRST116')
            ? `Username '${usernameToCheck}' not found.`
            : error.message
          );
        }
        if (data) {
          rankDisplayDiv.innerHTML = `
            <p><strong>Username:</strong> ${data.username}</p>
            <p><strong>Rank Score:</strong> ${data.rank_score}</p>
            <p><strong>Location:</strong> ${data.city}, ${data.state}</p>
          `;
        } else {
          rankDisplayDiv.innerHTML = `<p>Username '${usernameToCheck}' not found.</p>`;
        }
      } catch (err) {
        console.error('Check rank error:', err);
        displayError(rankErrorDiv, err.message);
        rankDisplayDiv.innerHTML = '';
      }
    });

    // --- Enter Game ---
    enterGameForm?.addEventListener('submit', async e => {
      e.preventDefault();
      if (!supabaseClient) return displayError(enterGameErrorDiv, 'Backend not initialized.');
      if (!currentUser) return displayError(enterGameErrorDiv, 'You must be logged in to enter a game.');
      clearMessages(enterGameErrorDiv, enterGameSuccessDiv);

      const gameCode = enterGameForm.game_code.value.trim().toUpperCase();
      if (!gameCode) {
        return displayError(enterGameErrorDiv, 'Please enter a game code.');
      }

      try {
        const { data: gameData, error: gameError } = await supabaseClient
          .from('games')
          .select('id, status, game_type')
          .eq('game_code', gameCode)
          .in('status', ['pending','active'])
          .single();

        if (gameError || !gameData) {
          throw new Error(gameError?.code === 'PGRST116'
            ? `Game code '${gameCode}' not found or inactive.`
            : `Error finding game: ${gameError?.message || 'Unknown'}`);
        }

        displaySuccess(enterGameSuccessDiv, `Game code ${gameCode} (${gameData.game_type}) is valid.`);
        enterGameForm.reset();
      } catch (err) {
        console.error('Enter game error:', err);
        displayError(enterGameErrorDiv, `Error: ${err.message}`);
      }
    });

    // --- Create Game ---
    createGameForm?.addEventListener('submit', async e => {
      e.preventDefault();
      if (!supabaseClient) return displayError(createGameErrorDiv, 'Backend not initialized.');
      if (!currentUser || !userProfile || !userProfile.city || !userProfile.state) {
        return displayError(createGameErrorDiv, 'Must be logged in with city/state to create a game.');
      }
      clearMessages(createGameErrorDiv, createGameSuccessDiv);
      gameCodeDisplayDiv.textContent = '';

      const selectedGameType = createGameForm.querySelector('input[name="game_type"]:checked');
      if (!selectedGameType) {
        return displayError(createGameErrorDiv, 'Please select a game type.');
      }
      const gameType = selectedGameType.value;
      const newGameCode = generateGameCode(5);

      try {
        const { data, error } = await supabaseClient
          .from('games')
          .insert({
            game_code: newGameCode,
            game_type: gameType,
            creator_id: currentUser.id,
            city: userProfile.city,
            state: userProfile.state
          })
          .select()
          .single();

        if (error) {
          if (error.message.includes('duplicate key value violates unique constraint')) {
            throw new Error('Failed to generate a unique game code. Try again.');
          }
          throw error;
        }
        if (!data) {
          throw new Error('Game creation failed unexpectedly. No data returned.');
        }
        gameCodeDisplayDiv.textContent = `Game Created! Code: ${data.game_code}`;
        displaySuccess(createGameSuccessDiv, 'Game created successfully.');
        createGameForm.reset();
      } catch (err) {
        console.error('Create game error:', err);
        displayError(createGameErrorDiv, `Error: ${err.message}`);
      }
    });

    // --- Page Load ---
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM fully loaded.');
      if (supabaseClient) {
        // Uncomment if you suspect leftover sessions:
        // await supabaseClient.auth.signOut();
        showPage('home-page');
        await checkUserSession();
      } else {
        console.error('Supabase client not loaded - limited functionality');
        updateUIForLoggedOutUser();
        displayError(loginErrorDiv, 'Cannot connect to backend.');
        showPage('login-page');
      }
    });

    // --- Auth State Change ---
    if (supabaseClient) {
      supabaseClient.auth.onAuthStateChange(async (event, session) => {
        console.log('Auth state changed:', event, session);
        if ((event === 'SIGNED_IN' || event === 'USER_UPDATED') && session?.user) {
          currentUser = session.user;
          await fetchUserProfile(currentUser.id);
          updateUIForLoggedInUser();
          const activePageId = document.querySelector('.page.active')?.id;
          if (['login-page','signup-page'].includes(activePageId)) {
            showPage('home-page');
          }
        } else if (event === 'SIGNED_OUT') {
          updateUIForLoggedOutUser();
          showPage('home-page');
        }
      });
    }
  </script>
</body>
</html>
