<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Court App (Username/Password)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Styles -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      background: #fff;
      color: #000;
      overflow-x: hidden;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }
    h1 {
      font-size: 2rem;
      font-weight: 600;
      margin: 20px 0 30px;
    }
    h2 {
      font-size: 1.5rem;
      margin: 15px 0;
    }
    .basketball-icon {
      width: 120px;
      height: 120px;
      margin-top: 40px;
      margin-bottom: 20px;
    }
    .main-button,
    .back-button,
    .action-button {
      display: inline-block;
      border: 1px solid #000;
      border-radius: 9999px;
      background: #fff;
      color: #000;
      font-size: 1rem;
      font-weight: 500;
      padding: 14px 24px;
      margin: 8px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.15s;
    }
    .main-button:active,
    .back-button:active,
    .action-button:active {
      transform: scale(0.95);
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.15);
    }
    .main-button:hover,
    .back-button:hover,
    .action-button:hover {
      background: #f2f2f2;
    }
    .page {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transform: translateX(0);
      transition: opacity 0.4s, transform 0.4s;
      background: #fff;
    }
    .page.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(0);
    }
    .page-content {
      margin-top: 80px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .court-lines {
      position: absolute;
      top: 0;
      left: 50%;
      width: 300px;
      height: 300px;
      transform: translateX(-50%);
      opacity: 0.06;
      background: radial-gradient(circle at center, #000 20%, transparent 20%),
                  radial-gradient(circle at center, #000 20%, transparent 20%);
      background-size: 150px 150px;
      background-position: 0 0, 75px 75px;
      pointer-events: none;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      text-align: left;
    }
    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      outline: 0;
    }
    select {
      width: 100%;
      padding: 10px;
      margin-bottom: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      outline: 0;
    }
    .form-section {
      text-align: left;
      margin: 20px 0;
    }
    .alert {
      color: red;
      font-size: 0.9rem;
      margin-top: 10px;
    }
    ol {
      padding-left: 40px;
      text-align: left;
      margin: 20px auto;
    }

    /* Add top-right nav container for login/signup */
    .top-right-nav {
      position: absolute;
      top: 10px;
      right: 20px;
      z-index: 999; /* ensure buttons are visible above everything else */
    }
  </style>

  <!-- Load Supabase (UMD) so window.supabase is defined -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <!-- Our app code -->
  <script>
    // 1) Declare global variables FIRST
    let currentPage = "homePage";  // default page

    // 2) Create Supabase client using the global "supabase"
    const SUPABASE_URL = "https://ewsovztnigqhmuxptcih.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3c292enRuaWdxaG11eHB0Y2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM4NzkwNzMsImV4cCI6MjA1OTQ1NTA3M30.-O95N99gXxNZfaA1KH1_3wplHbQzffpvC1h4z1jw0-8";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // We'll store the currently "logged in" user's username & city after login.
    let currentUser = null;
    let currentUserCity = null;

    // 3) Functions that reference currentPage or supabaseClient
    async function navigateToPage(target) {
      document.getElementById(currentPage).classList.remove("active");
      document.getElementById(target).classList.add("active");
      currentPage = target;
    }

    // SIGN UP (username / password / city)
    async function signUpUser() {
      const signupUsername = document.getElementById("signupUsername").value.trim();
      const signupPassword = document.getElementById("signupPassword").value.trim();
      const signupCity = document.getElementById("signupCity").value.trim();
      const signupError = document.getElementById("signupError");

      signupError.textContent = "";
      if (!signupUsername || !signupPassword) {
        signupError.textContent = "Please provide a username and password.";
        return;
      }

      try {
        // Check if username already exists in "users" table
        const { data: existingUser } = await supabaseClient
          .from("users")
          .select("*")
          .eq("username", signupUsername)
          .maybeSingle();

        if (existingUser) {
          signupError.textContent = "Username already taken.";
          return;
        }

        // Insert user into "users" table (demo only - password is stored in plain text!)
        const { error: insertUserError } = await supabaseClient
          .from("users")
          .insert([
            { 
              username: signupUsername,
              password: signupPassword,
              city: signupCity
            }
          ]);

        if (insertUserError) {
          signupError.textContent = "Error creating user account.";
          return;
        }

        // Also insert a row in monthly_rankings for this new user/city
        if (signupCity) {
          await supabaseClient.from("monthly_rankings").insert([
            { username: signupUsername, city: signupCity }
          ]);
        }

        // On success, consider this user "logged in"
        currentUser = signupUsername;
        currentUserCity = signupCity;

        alert("Signed up successfully!");
        navigateToPage("homePage");
      } catch (e) {
        signupError.textContent = "An error occurred during sign up.";
      }
    }

    // LOGIN (check username/password in "users" table)
    async function loginUser() {
      const loginUsername = document.getElementById("loginUsername").value.trim();
      const loginPassword = document.getElementById("loginPassword").value.trim();
      const loginError = document.getElementById("loginError");

      loginError.textContent = "";
      if (!loginUsername || !loginPassword) {
        loginError.textContent = "Please provide username and password.";
        return;
      }

      try {
        // Query "users" table for that username
        const { data: userRow, error } = await supabaseClient
          .from("users")
          .select("*")
          .eq("username", loginUsername)
          .maybeSingle();

        if (error) {
          loginError.textContent = "Error logging in.";
          return;
        }
        // If user not found or password mismatch
        if (!userRow || userRow.password !== loginPassword) {
          loginError.textContent = "Invalid username or password.";
          return;
        }

        // On success, set "logged in" user
        currentUser = userRow.username;
        currentUserCity = userRow.city || null;

        alert("Logged in successfully!");
        navigateToPage("homePage");
      } catch (e) {
        loginError.textContent = "An error occurred during login.";
      }
    }

    // CHECK RANK
    async function checkRank() {
      const username = document.getElementById("usernameRank").value.trim();
      const rankDisplay = document.getElementById("rankDisplay");
      const rankError = document.getElementById("rankError");
      rankError.textContent = "";

      if (!username) {
        rankError.textContent = "Please enter your username.";
        return;
      }

      try {
        const { data, error } = await supabaseClient
          .from("monthly_rankings")
          .select("ranking, city")
          .eq("username", username)
          .maybeSingle();

        if (error) {
          rankError.textContent = "Error fetching rank.";
          return;
        }
        if (!data) {
          rankDisplay.textContent = "No rank found.";
          return;
        }
        rankDisplay.textContent =
          "#" + data.ranking + (data.city ? " in " + data.city : "");
      } catch (e) {
        rankError.textContent = "Error fetching rank.";
      }
    }

    // ENTER GAME
    async function enterGame() {
      const code = document.getElementById("gameCodeInput").value.trim();
      const err = document.getElementById("enterGameError");
      err.textContent = "";

      if (!code) {
        err.textContent = "Please enter a game code.";
        return;
      }

      if (!currentUser) {
        err.textContent = "You need to be logged in to join a game.";
        return;
      }

      try {
        const { data, error } = await supabaseClient
          .from("games")
          .select("id")
          .eq("game_code", code)
          .maybeSingle();

        if (error) {
          err.textContent = "Error searching for game.";
          return;
        }
        if (!data) {
          err.textContent = "Game not found.";
          return;
        }

        // Insert user into 'game_players' table
        await supabaseClient.from("game_players").insert([
          { game_id: data.id, user_name: currentUser }
        ]);

        navigateToPage("homePage");
      } catch (e) {
        err.textContent = "Could not join game.";
      }
    }

    // CREATE GAME
    async function createGame() {
      const type = document.getElementById("gameType").value;
      const res = document.getElementById("createGameResult");
      res.textContent = "";

      if (!currentUser) {
        res.textContent = "You must be logged in to create a game.";
        return;
      }

      try {
        // Generate a random code
        const randomCode = Math.random().toString(36).slice(2, 8).toUpperCase();

        const { data, error } = await supabaseClient
          .from("games")
          .insert([
            {
              game_code: randomCode,
              max_players: parseInt(type),
              created_by: currentUser
            }
          ])
          .select("game_code")
          .single();

        if (error) {
          res.textContent = "Error creating game.";
          return;
        }

        res.textContent = "Game created. Code: " + data.game_code;
      } catch (e) {
        res.textContent = "Error creating game.";
      }
    }
  </script>
</head>

<body>
  <div class="container">
    <div class="court-lines"></div>

    <!-- TOP-RIGHT NAV for login/signup -->
    <div class="top-right-nav">
      <button class="action-button" onclick="navigateToPage('loginPage')">Login</button>
      <button class="action-button" onclick="navigateToPage('signupPage')">Sign Up</button>
    </div>

    <!-- HOME PAGE -->
    <div id="homePage" class="page active">
      <img
        src="https://i.ibb.co/VY7wFGTd/Chat-GPT-Image-Apr-5-2025-03-04-00-PM.png"
        alt="Basketball Icon"
        class="basketball-icon"
      />
      <h1>Court</h1>
      <button class="main-button" onclick="navigateToPage('checkRankPage')">Check Rank</button>
      <button class="main-button" onclick="navigateToPage('enterGamePage')">Enter Game</button>
      <button class="main-button" onclick="navigateToPage('leaderboardPage')">Leaderboard</button>
      <button class="main-button" onclick="navigateToPage('createGamePage')">Create Game</button>
    </div>

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="page">
      <div class="page-content">
        <h2>Login</h2>
        <div class="form-section">
          <label for="loginUsername">Username</label>
          <input type="text" id="loginUsername" placeholder="Username" />
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" placeholder="Password" />
          <button class="action-button" onclick="loginUser()">Login</button>
          <div id="loginError" class="alert"></div>
        </div>
        <button class="back-button" onclick="navigateToPage('homePage')">Back</button>
      </div>
    </div>

    <!-- SIGN UP PAGE -->
    <div id="signupPage" class="page">
      <div class="page-content">
        <h2>Sign Up</h2>
        <div class="form-section">
          <label for="signupUsername">Username</label>
          <input type="text" id="signupUsername" placeholder="Username" />
          <label for="signupPassword">Password</label>
          <input type="password" id="signupPassword" placeholder="Password" />
          <label for="signupCity">City (optional)</label>
          <input type="text" id="signupCity" placeholder="City" />
          <button class="action-button" onclick="signUpUser()">Sign Up</button>
          <div id="signupError" class="alert"></div>
        </div>
        <button class="back-button" onclick="navigateToPage('homePage')">Back</button>
      </div>
    </div>

    <!-- CHECK RANK PAGE -->
    <div id="checkRankPage" class="page">
      <div class="page-content">
        <h2>Your Rank</h2>
        <p id="rankDisplay">#??</p>
        <div class="form-section">
          <label for="usernameRank">Username</label>
          <input type="text" id="usernameRank" placeholder="Enter username" />
          <button class="action-button" onclick="checkRank()">Check My Rank</button>
          <div id="rankError" class="alert"></div>
        </div>
        <button class="back-button" onclick="navigateToPage('homePage')">Back</button>
      </div>
    </div>

    <!-- ENTER GAME PAGE -->
    <div id="enterGamePage" class="page">
      <div class="page-content">
        <h2>Enter Game</h2>
        <div class="form-section">
          <label for="gameCodeInput">Game Code</label>
          <input type="text" id="gameCodeInput" placeholder="XYZ123" />
          <button class="action-button" onclick="enterGame()">Join</button>
          <div id="enterGameError" class="alert"></div>
        </div>
        <button class="back-button" onclick="navigateToPage('homePage')">Back</button>
      </div>
    </div>

    <!-- LEADERBOARD PAGE -->
    <div id="leaderboardPage" class="page">
      <div class="page-content">
        <h2>Leaderboard</h2>
        <ol id="leaderboardList"></ol>
        <button class="back-button" onclick="navigateToPage('homePage')">Back</button>
      </div>
    </div>

    <!-- CREATE GAME PAGE -->
    <div id="createGamePage" class="page">
      <div class="page-content">
        <h2>Create Game</h2>
        <div class="form-section">
          <label for="gameType">Match Type</label>
          <select id="gameType">
            <option value="4">2 vs 2</option>
            <option value="6">3 vs 3</option>
            <option value="2">1 vs 1</option>
          </select>
          <button class="action-button" onclick="createGame()">Generate Code</button>
          <div id="createGameResult" class="alert"></div>
        </div>
        <button class="back-button" onclick="navigateToPage('homePage')">Back</button>
      </div>
    </div>
  </div>
</body>
</html>
